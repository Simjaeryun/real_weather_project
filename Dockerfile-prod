# ===== DEPENDENCIES STAGE =====
# Base ì´ë¯¸ì§€ì—ì„œ node_modulesë§Œ ê°€ì ¸ì˜¤ê¸°
ARG BASE_IMAGE_FE=fsd-weather-base:latest
FROM ${BASE_IMAGE_FE} AS dependencies

# ===== BUILDER STAGE =====
# ì‹¤ì œ ë¹Œë“œë¥¼ ìœ„í•œ ê¹¨ë—í•œ ì´ë¯¸ì§€ ì‹œì‘
FROM node:20-alpine AS builder

# ë¹Œë“œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ARG APP_ENV="production"
ARG NODE_OPTIONS="--max-old-space-size=2048"
ARG DISCORD_WEBHOOK_URL=""

# Node.js ë©”ëª¨ë¦¬ ì˜µì…˜ ì„¤ì •
ENV NODE_OPTIONS=${NODE_OPTIONS}
# Next.js í…”ë ˆë©”íŠ¸ë¦¬ ë¹„í™œì„±í™” (ì„±ëŠ¥ í–¥ìƒ)
ENV NEXT_TELEMETRY_DISABLED=1

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ë¹Œë“œ ì‹œì‘ ë¡œê·¸ ì¶œë ¥ ë° Discord ì•Œë¦¼ (ì„ íƒì‚¬í•­)
RUN echo "#####################################################################" && \
    echo "# [START] BUILD [WEATHER-APP] [${APP_ENV}]                          #" && \
    echo "#####################################################################" && \
    echo "01. DATE : $(date)" && \
    (if [ -n "$DISCORD_WEBHOOK_URL" ]; then \
        echo "Sending Discord notification..." && \
        apk add --no-cache wget && \
        wget -q -O- --timeout=10 --tries=2 \
        --header="Content-Type: application/json" \
        --post-data="{\"embeds\":[{\"title\":\"ğŸ—ï¸ WEATHER-APP ë¹Œë“œ ì‹œì‘\",\"description\":\"í™˜ê²½: ${APP_ENV}\\në©”ëª¨ë¦¬: ${NODE_OPTIONS}\\nì‹œì‘ ì‹œê°„: $(date)\",\"color\":5865522,\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}]}" \
        $DISCORD_WEBHOOK_URL && echo "Discord notification sent" || echo "Discord notification failed (ignored)"; \
    else \
        echo "Discord webhook not configured (skipping)"; \
    fi) || true

# Base ì´ë¯¸ì§€ì—ì„œ node_modulesë§Œ ë³µì‚¬
COPY --from=dependencies /app/node_modules ./node_modules

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì •ë¦¬ ë° ì„¤ì •
RUN echo "02. Setting up environment files..." && \
    # .env.prodê°€ ìˆìœ¼ë©´ .env.productionìœ¼ë¡œ ë³µì‚¬
    if [ -f .env.prod ]; then \
        echo "Found .env.prod, copying to .env.production" && \
        cp .env.prod .env.production; \
    fi && \
    # .env íŒŒì¼ì´ ì—†ìœ¼ë©´ env.exampleì„ ë³µì‚¬
    if [ ! -f .env ] && [ ! -f .env.production ]; then \
        echo "No .env file found, using env.example with defaults" && \
        cp env.example .env && \
        sed -i 's/your_vworld_api_key_here//g' .env; \
    fi && \
    # .envì™€ .env.productionë§Œ ìœ ì§€, ë‚˜ë¨¸ì§€ ì‚­ì œ (.env.local í¬í•¨)
    find . -name ".env*" ! -name ".env.production" ! -name ".env" -type f -delete && \
    echo "Environment setup completed" && \
    echo "Using environment files:" && \
    ls -la .env* 2>/dev/null || echo "No .env files found"

# Next.js ì•± ë¹Œë“œ ì‹¤í–‰
RUN echo "03. Building Next.js application..." && npm run build

# ë¹Œë“œ ì„±ê³µ ì•Œë¦¼ (ì„ íƒì‚¬í•­ - ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ)
RUN (if [ -n "$DISCORD_WEBHOOK_URL" ]; then \
        echo "Sending build success notification..." && \
        wget -q -O- --timeout=10 --tries=2 \
        --header="Content-Type: application/json" \
        --post-data="{\"embeds\":[{\"title\":\"âœ… WEATHER-APP ë¹Œë“œ ì™„ë£Œ\",\"description\":\"í™˜ê²½: ${APP_ENV}\\nì™„ë£Œ ì‹œê°„: $(date)\",\"color\":5763719,\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}]}" \
        $DISCORD_WEBHOOK_URL && echo "Discord notification sent" || echo "Discord notification failed (ignored)"; \
    else \
        echo "Discord webhook not configured (skipping)"; \
    fi) || true

# Show build result structure
RUN apk add --no-cache tree && \
    echo "################################################" && \
    echo "# [BUILD RESULT] STRUCTURE                     #" && \
    echo "################################################" && \
    tree -I 'node_modules' -L 3 .next

# ===== RUNTIME STAGE =====
# ê²½ëŸ‰í™”ëœ Node.js ëŸ°íƒ€ì„ ì´ë¯¸ì§€ ì‚¬ìš©
FROM node:20-alpine AS runner

# ëŸ°íƒ€ì„ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ARG APP_ENV="production"

# í™˜ê²½ ë³€ìˆ˜ë¥¼ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
ENV APP_ENV=${APP_ENV}
# í”„ë¡œë•ì…˜ ëª¨ë“œë¡œ ì‹¤í–‰ (ìµœì í™”ëœ ì„±ëŠ¥)
ENV NODE_ENV=production
# í¬íŠ¸ ì„¤ì •
ENV PORT=3000
# Next.js í…”ë ˆë©”íŠ¸ë¦¬ ë¹„í™œì„±í™”
ENV NEXT_TELEMETRY_DISABLED=1

# ëŸ°íƒ€ì„ ì‹œì‘ ë¡œê·¸ ì¶œë ¥
RUN echo "#####################################################################" && \
    echo "# [START] RUNTIME [WEATHER-APP] [${APP_ENV}]                        #" && \
    echo "#####################################################################"

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# Install tree for runtime structure viewing
RUN apk add --no-cache tree

# ë³´ì•ˆì„ ìœ„í•œ non-root ì‚¬ìš©ì ìƒì„±
# nodejs ê·¸ë£¹ ìƒì„± (GID: 1001)
RUN addgroup --system --gid 1001 nodejs && \
    # nextjs ì‚¬ìš©ì ìƒì„± (UID: 1001, nodejs ê·¸ë£¹ ì†Œì†)
    adduser --system --uid 1001 nextjs

# ë¹Œë” ìŠ¤í…Œì´ì§€ì—ì„œ ë¹Œë“œëœ íŒŒì¼ë“¤ì„ ëŸ°íƒ€ì„ ì´ë¯¸ì§€ë¡œ ë³µì‚¬
# standalone ì„œë²„ íŒŒì¼ ë³µì‚¬ (Next.js ë…ë¦½ ì‹¤í–‰ íŒŒì¼)
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
# ì •ì  íŒŒì¼ ë³µì‚¬ (CSS, JS, ì´ë¯¸ì§€ ë“±)
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
# public í´ë” ë³µì‚¬ (ì •ì  ìì‚°)
COPY --from=builder --chown=nextjs:nodejs /app/public ./public

# Show final runtime structure
RUN echo "################################################" && \
    echo "# [RUNTIME] FINAL STRUCTURE                    #" && \
    echo "################################################" && \
    tree -I 'node_modules' -L 3

# ë³´ì•ˆì„ ìœ„í•´ non-root ì‚¬ìš©ìë¡œ ì „í™˜
USER nextjs

# ì»¨í…Œì´ë„ˆê°€ ì‚¬ìš©í•  í¬íŠ¸ ë…¸ì¶œ
EXPOSE ${PORT}

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëª…ë ¹ì–´ (standalone ì„œë²„ ì‹¤í–‰)
CMD ["node", "server.js"]

 